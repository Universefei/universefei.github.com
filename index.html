<!doctype html>
<html class="theme-next use-motion ">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>




  <meta name="keywords" content="Hexo,next" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    analytics: {
      google: ''
    },
    sidebar: 'post'
  };
</script>




  <title> Fei Lunzhou </title>
</head>

<body>
  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->

  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Fei Lunzhou</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<div class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/">
            <i class="menu-item-icon icon-home"></i> <br />
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            <i class="menu-item-icon icon-archives"></i> <br />
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            <i class="menu-item-icon icon-tags"></i> <br />
            標籤
          </a>
        </li>
      
    </ul>
  

  
</div>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <div id="posts" class="posts-expand">
    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/05/15/数据库存储管理/">
                数据库存储管理
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2015-05-15
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/05/15/数据库存储管理/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/05/15/数据库存储管理/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/03/14/GIS/用PL-pgSQL对osm数据进行矢量分级/">
                用PL/pgSQL对osm数据进行矢量分级
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2015-03-14
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/03/14/GIS/用PL-pgSQL对osm数据进行矢量分级/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/14/GIS/用PL-pgSQL对osm数据进行矢量分级/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h3 id="执行总流程介绍">执行总流程介绍</h3><p>Perform-sql-updates.sql是总执行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line"><span class="comment"># subsequent sql depends on functions installed</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Creating functions..."</span></span><br><span class="line">psql <span class="variable">$@</span> <span class="operator">-f</span> functions.sql</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"done."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apply updates in parallel across tables</span></span><br><span class="line"><span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"\nApplying updates in parallel across tables..."</span></span><br><span class="line">psql <span class="variable">$@</span> <span class="operator">-f</span> apply-updates-non-planet-tables.sql &amp;</span><br><span class="line">psql <span class="variable">$@</span> <span class="operator">-f</span> apply-planet_osm_polygon.sql &amp;</span><br><span class="line">psql <span class="variable">$@</span> <span class="operator">-f</span> apply-planet_osm_line.sql &amp;</span><br><span class="line">psql <span class="variable">$@</span> <span class="operator">-f</span> apply-planet_osm_point.sql &amp;</span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"done."</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">'\nApplying triggers...'</span></span><br><span class="line">psql <span class="variable">$@</span> <span class="operator">-f</span> triggers.sql</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'done.'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"\nAll updates complete. Exiting."</span></span><br></pre></td></tr></table></figure>
<h3 id="对non-planet表进行处理">对non-planet表进行处理</h3><p>apply-updates-non-planet-tables.sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">DO</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- add way_area columns to all tables that use it</span></span><br><span class="line">PERFORM mz_add_area_column(<span class="string">'ne_110m_ocean'</span>, <span class="string">'way_area'</span>, <span class="string">'the_geom'</span>);</span></span><br><span class="line">PERFORM mz_add_area_column('ne_110m_lakes', 'way_area', 'the_geom');</span><br><span class="line">PERFORM mz_add_area_column('ne_50m_ocean', 'way_area', 'the_geom');</span><br><span class="line">PERFORM mz_add_area_column('ne_50m_lakes', 'way_area', 'the_geom');</span><br><span class="line">PERFORM mz_add_area_column('ne_50m_playas', 'way_area', 'the_geom');</span><br><span class="line">PERFORM mz_add_area_column('ne_10m_ocean', 'way_area', 'the_geom');</span><br><span class="line">PERFORM mz_add_area_column('ne_10m_lakes', 'way_area', 'the_geom');</span><br><span class="line">PERFORM mz_add_area_column('ne_10m_playas', 'way_area', 'the_geom');</span><br><span class="line">PERFORM mz_add_area_column('water_polygons', 'way_area', 'the_geom');</span><br><span class="line">PERFORM mz_add_area_column('ne_10m_urban_areas', 'way_area', 'the_geom');</span><br><span class="line">PERFORM mz_add_area_column('ne_50m_urban_areas', 'way_area', 'the_geom');</span><br><span class="line">PERFORM mz_add_area_column('ne_10m_parks_and_protected_lands', 'way_area', 'the_geom');</span><br><span class="line"></span><br><span class="line"><span class="comment">-- way_area indexes</span></span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_110m_ocean_wayarea_index', 'ne_110m_ocean', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_110m_lakes_wayarea_index', 'ne_110m_lakes', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_50m_ocean_wayarea_index', 'ne_50m_ocean', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_50m_lakes_wayarea_index', 'ne_50m_lakes', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_50m_playas_wayarea_index', 'ne_50m_playas', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_50m_urban_areas_way_area_index', 'ne_50m_urban_areas', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_10m_ocean_wayarea_index', 'ne_10m_ocean', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_10m_lakes_wayarea_index', 'ne_10m_lakes', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_10m_playas_wayarea_index', 'ne_10m_playas', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_10m_urban_areas_way_area_index', 'ne_10m_urban_areas', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_10m_parks_and_protected_lands_way_area_index', 'ne_10m_parks_and_protected_lands', 'way_area');</span><br><span class="line">PERFORM mz_create_index_if_not_exists('water_polygons_wayarea_index', 'water_polygons', 'way_area');</span><br><span class="line"></span><br><span class="line"><span class="comment">-- additional updates</span></span><br><span class="line">PERFORM mz_create_index_if_not_exists('ne_10m_populated_places_scalerank_index', 'ne_10m_populated_places', 'scalerank');</span><br><span class="line"></span><br><span class="line">PERFORM AddGeometryColumn('ne_50m_urban_areas', 'mz_centroid', 900913, 'Geometry', 2);</span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> ne_50m_urban_areas <span class="keyword">SET</span> mz_centroid=ST_Centroid(the_geom);</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> ne_50m_urban_areas_centroid_index <span class="keyword">ON</span> ne_50m_urban_areas <span class="keyword">USING</span> gist(mz_centroid);</span></span><br><span class="line"></span><br><span class="line">PERFORM AddGeometryColumn('ne_10m_parks_and_protected_lands', 'mz_centroid', 900913, 'Geometry', 2);</span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> ne_10m_parks_and_protected_lands <span class="keyword">SET</span> mz_centroid=ST_Centroid(the_geom);</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> ne_10m_parks_and_protected_lands_centroid_index <span class="keyword">ON</span> ne_10m_parks_and_protected_lands <span class="keyword">USING</span> gist(mz_centroid);</span></span><br><span class="line"></span><br><span class="line">PERFORM AddGeometryColumn('ne_10m_urban_areas', 'mz_centroid', 900913, 'Geometry', 2);</span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> ne_10m_urban_areas <span class="keyword">SET</span> mz_centroid=ST_Centroid(the_geom);</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> ne_10m_urban_areas_centroid_index <span class="keyword">ON</span> ne_10m_urban_areas <span class="keyword">USING</span> gist(mz_centroid);</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">END</span> $$;</span></span><br></pre></td></tr></table></figure>
<h3 id="对planet_osm_polygon表做处理">对planet_osm_polygon表做处理</h3><p>apply_planet_osm_polygon.sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">DO</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-- planet_osm_polygon</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- indexes on existing columns</span></span><br><span class="line">PERFORM mz_create_index_if_not_exists(<span class="string">'planet_osm_polygon_wayarea_index'</span>, <span class="string">'planet_osm_polygon'</span>, <span class="string">'way_area'</span>);</span></span><br><span class="line">PERFORM mz_create_partial_index_if_not_exists('planet_osm_polygon_building_index', 'planet_osm_polygon', 'building', 'building IS NOT NULL');</span><br><span class="line">PERFORM mz_create_partial_index_if_not_exists('planet_osm_polygon_admin_level_index', 'planet_osm_polygon', 'admin_level', 'boundary = ''administrative''');</span><br><span class="line"></span><br><span class="line"><span class="comment">-- indexes on functions</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> planet_osm_polygon_is_building_or_part_index <span class="keyword">ON</span> planet_osm_polygon(mz_calculate_is_building_or_part(building, <span class="string">"building:part"</span>)) <span class="keyword">WHERE</span> mz_calculate_is_building_or_part(building, <span class="string">"building:part"</span>) = <span class="literal">TRUE</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> planet_osm_polygon_is_water_index <span class="keyword">ON</span> planet_osm_polygon(mz_calculate_is_water(<span class="string">"waterway"</span>, <span class="string">"natural"</span>, <span class="string">"landuse"</span>)) <span class="keyword">WHERE</span> mz_calculate_is_water(<span class="string">"waterway"</span>, <span class="string">"natural"</span>, <span class="string">"landuse"</span>) = <span class="literal">TRUE</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- update polygon table to add centroids</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> planet_osm_polygon <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> mz_is_landuse <span class="built_in">BOOLEAN</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> planet_osm_polygon <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> mz_centroid GEOMETRY;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- at the moment we only add centroids to landuse features</span></span><br><span class="line"><span class="operator"><span class="keyword">UPDATE</span> planet_osm_polygon <span class="keyword">SET</span></span><br><span class="line">    mz_is_landuse = <span class="literal">TRUE</span>,</span><br><span class="line">    mz_centroid = ST_Centroid(way)</span><br><span class="line">    <span class="keyword">WHERE</span> mz_calculate_is_landuse(<span class="string">"landuse"</span>, <span class="string">"leisure"</span>, <span class="string">"natural"</span>, <span class="string">"highway"</span>, <span class="string">"amenity"</span>, <span class="string">"aeroway"</span>) = <span class="literal">TRUE</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- indexes for centroid queries</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> planet_osm_polygon_is_landuse_col_index <span class="keyword">ON</span> planet_osm_polygon(mz_is_landuse) <span class="keyword">WHERE</span> mz_is_landuse=<span class="literal">TRUE</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> planet_osm_polygon_centroid_landuse_index <span class="keyword">ON</span> planet_osm_polygon <span class="keyword">USING</span> gist(mz_centroid) <span class="keyword">WHERE</span> mz_is_landuse=<span class="literal">TRUE</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">END</span> $$;</span></span><br></pre></td></tr></table></figure>
<h3 id="对planet_osm_point表做处理">对planet_osm_point表做处理</h3><p>apply-planet_osm_point.sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">DO</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-- planet_osm_point</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> planet_osm_point_place_index <span class="keyword">ON</span> planet_osm_point(place) <span class="keyword">WHERE</span> name <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> place <span class="keyword">IN</span> (<span class="string">'city'</span>, <span class="string">'continent'</span>, <span class="string">'country'</span>, <span class="string">'county'</span>, <span class="string">'district'</span>, <span class="string">'hamlet'</span>, <span class="string">'island'</span>, <span class="string">'isolated_dwelling'</span>, <span class="string">'lake'</span>, <span class="string">'locality'</span>, <span class="string">'neighbourhood'</span>, <span class="string">'ocean'</span>, <span class="string">'province'</span>, <span class="string">'sea'</span>, <span class="string">'state'</span>, <span class="string">'suburb'</span>, <span class="string">'town'</span>, <span class="string">'village'</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> planet_osm_point_level_index <span class="keyword">ON</span> planet_osm_point(mz_calculate_poi_level(<span class="string">"aerialway"</span>, <span class="string">"aeroway"</span>, <span class="string">"amenity"</span>, <span class="string">"barrier"</span>, <span class="string">"highway"</span>, <span class="string">"historic"</span>, <span class="string">"leisure"</span>, <span class="string">"lock"</span>, <span class="string">"man_made"</span>, <span class="string">"natural"</span>, <span class="string">"power"</span>, <span class="string">"railway"</span>, <span class="string">"shop"</span>, <span class="string">"tourism"</span>, <span class="string">"waterway"</span>)) <span class="keyword">WHERE</span> mz_calculate_poi_level(<span class="string">"aerialway"</span>, <span class="string">"aeroway"</span>, <span class="string">"amenity"</span>, <span class="string">"barrier"</span>, <span class="string">"highway"</span>, <span class="string">"historic"</span>, <span class="string">"leisure"</span>, <span class="string">"lock"</span>, <span class="string">"man_made"</span>, <span class="string">"natural"</span>, <span class="string">"power"</span>, <span class="string">"railway"</span>, <span class="string">"shop"</span>, <span class="string">"tourism"</span>, <span class="string">"waterway"</span>) <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">END</span> $$;</span></span><br></pre></td></tr></table></figure>
<h3 id="对planet_osm_line表做处理">对planet_osm_line表做处理</h3><p>apply-planet_osm_line.sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">DO</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-- planet_osm_line</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- indexes on existing columns</span></span><br><span class="line">PERFORM mz_create_partial_index_if_not_exists(<span class="string">'planet_osm_line_waterway'</span>, <span class="string">'planet_osm_line'</span>, <span class="string">'waterway'</span>, <span class="string">'waterway IS NOT NULL'</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- indexes on functions</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> planet_osm_line_road_level_index <span class="keyword">ON</span> planet_osm_line(mz_calculate_road_level(highway, railway, aeroway)) <span class="keyword">WHERE</span> mz_calculate_road_level(highway, railway, aeroway) <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">END</span> $$;</span></span><br></pre></td></tr></table></figure>
<h3 id="导入的函数">导入的函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_does_index_exist()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- used to check whether an index exists before adding</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_does_index_exist(index_name <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">BOOLEAN</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> pg_class <span class="keyword">AS</span> c</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> pg_namespace <span class="keyword">AS</span> n <span class="keyword">ON</span> n.oid = c.relnamespace</span><br><span class="line">        <span class="keyword">WHERE</span> c.relname = index_name</span><br><span class="line">    );</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql STABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_does_trigger_exist()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_does_trigger_exist(trigger_name <span class="built_in">text</span>, table_name <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">BOOLEAN</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">EXISTS</span>(</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> pg_class <span class="keyword">AS</span> c</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> pg_namespace <span class="keyword">AS</span> n <span class="keyword">ON</span> n.oid = c.relnamespace</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> pg_trigger <span class="keyword">AS</span> t <span class="keyword">ON</span> t.tgrelid = c.oid</span><br><span class="line">        <span class="keyword">WHERE</span> c.relname = table_name</span><br><span class="line">          <span class="keyword">AND</span> t.tgname = trigger_name</span><br><span class="line">    );</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql STABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_create_index_if_not_exists()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_create_index_if_not_exists(index_name <span class="built_in">text</span>, table_name <span class="built_in">text</span>, column_name <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> VOID <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">IF</span> <span class="keyword">NOT</span> mz_does_index_exist(index_name) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">EXECUTE</span> <span class="string">'CREATE INDEX '</span> ||</span><br><span class="line">            quote_ident(index_name) || <span class="string">' ON '</span> || quote_ident(table_name) ||</span><br><span class="line">            <span class="string">'('</span> || quote_ident(column_name) || <span class="string">')'</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql VOLATILE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_create_partial_index_if_not_exists()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_create_partial_index_if_not_exists(index_name <span class="built_in">text</span>, table_name <span class="built_in">text</span>, column_name <span class="built_in">text</span>, where_clause <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> VOID <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">IF</span> <span class="keyword">NOT</span> mz_does_index_exist(index_name) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">EXECUTE</span> <span class="string">'CREATE INDEX '</span> ||</span><br><span class="line">            quote_ident(index_name) || <span class="string">' ON '</span> || quote_ident(table_name) ||</span><br><span class="line">            <span class="string">'('</span> || quote_ident(column_name) || <span class="string">') WHERE '</span> || where_clause;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql VOLATILE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_create_trigger_if_not_exists()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_create_trigger_if_not_exists(</span><br><span class="line">    trigger_name <span class="built_in">text</span>, table_name <span class="built_in">text</span>, function_name <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> VOID <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">IF</span> <span class="keyword">NOT</span> mz_does_trigger_exist(trigger_name, table_name) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">EXECUTE</span> <span class="string">'CREATE TRIGGER '</span> || quote_ident(trigger_name) ||</span><br><span class="line">          <span class="string">' BEFORE INSERT OR UPDATE ON '</span> || quote_ident(table_name) ||</span><br><span class="line">          <span class="string">' FOR EACH ROW EXECUTE PROCEDURE '</span> || quote_ident(function_name) || <span class="string">'()'</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql VOLATILE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_does_column_exist()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_does_column_exist(input_table_name <span class="built_in">text</span>, input_column_name <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">BOOLEAN</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> information_schema.<span class="keyword">columns</span></span><br><span class="line">        <span class="keyword">WHERE</span> table_name=input_table_name <span class="keyword">AND</span> column_name=input_column_name</span><br><span class="line">    );</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql STABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_add_simplified_geometry_column()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_add_simplified_geometry_column(</span><br><span class="line">    table_name <span class="built_in">text</span>, column_name <span class="built_in">text</span>, existing_geom_column_name <span class="built_in">text</span>, geom_type <span class="built_in">text</span>, tolerance <span class="built_in">float</span>, where_clause <span class="built_in">text</span> <span class="keyword">default</span> <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> VOID <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">DECLARE</span> v_where_clause <span class="built_in">TEXT</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">DECLARE</span> v_index_where <span class="built_in">TEXT</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">IF</span> <span class="keyword">NOT</span> mz_does_column_exist(table_name, column_name) <span class="keyword">THEN</span></span><br><span class="line">        PERFORM AddGeometryColumn(table_name, column_name, <span class="number">900913</span>, geom_type, <span class="number">2</span>);</span></span><br><span class="line">        IF where_clause IS NOT NULL THEN</span><br><span class="line">            v_where_clause := ' AND ' || where_clause;</span><br><span class="line">            v_index_where := ' WHERE ' || where_clause;</span><br><span class="line">        <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">EXECUTE</span> <span class="string">'UPDATE '</span> || quote_ident(table_name) ||</span><br><span class="line">            <span class="string">' SET '</span> || quote_ident(column_name) ||</span><br><span class="line">            <span class="string">'=ST_SimplifyPreserveTopology('</span> || quote_ident(existing_geom_column_name) ||</span><br><span class="line">            <span class="string">', '</span> || tolerance || <span class="string">')'</span> ||</span><br><span class="line">            <span class="string">' WHERE '</span> || quote_ident(existing_geom_column_name) || <span class="string">' IS NOT NULL'</span> ||</span><br><span class="line">            v_where_clause;</span></span><br><span class="line">        <span class="operator"><span class="keyword">EXECUTE</span> <span class="string">'CREATE INDEX '</span> || quote_ident(table_name || <span class="string">'_'</span> || column_name) ||</span><br><span class="line">            <span class="string">' ON '</span> || quote_ident(table_name) || <span class="string">' USING gist('</span> || quote_ident(column_name) || <span class="string">')'</span> ||</span><br><span class="line">            v_index_where;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql VOLATILE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_safe_convert_to_float()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_safe_convert_to_float(v_input <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">FLOAT</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">DECLARE</span> v_float_value <span class="built_in">FLOAT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        v_float_value := TO_NUMBER(</span><br><span class="line">            <span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(v_input, <span class="string">';'</span>, <span class="string">'.'</span>), <span class="string">','</span>, <span class="string">'.'</span>),</span><br><span class="line">            <span class="string">'999999D99S'</span>) <span class="keyword">AS</span> <span class="built_in">FLOAT</span>;</span></span><br><span class="line">    EXCEPTION WHEN OTHERS THEN</span><br><span class="line">        RETURN NULL;</span><br><span class="line">    <span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">    RETURN v_float_value;</span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql IMMUTABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_normalize_id()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_normalize_id(id <span class="built_in">bigint</span>, geom Geometry)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">TEXT</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">IF</span> id &lt; <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">RETURN</span> <span class="keyword">Substr</span>(<span class="keyword">MD5</span>(ST_AsBinary(geom)), <span class="number">1</span>, <span class="number">10</span>);</span></span><br><span class="line">    ELSE</span><br><span class="line">        RETURN id::text;</span><br><span class="line">    <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql STABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_add_normalized_id()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_add_normalized_id(</span><br><span class="line">    table_name <span class="built_in">text</span>, column_name <span class="built_in">text</span>, geom_name <span class="built_in">text</span>, prev_id_column_name <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> VOID <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">IF</span> <span class="keyword">NOT</span> mz_does_column_exist(table_name, column_name) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">EXECUTE</span> <span class="string">'ALTER TABLE '</span> || quote_ident(table_name) ||</span><br><span class="line">                <span class="string">' ADD COLUMN '</span> || quote_ident(column_name) ||</span><br><span class="line">                <span class="string">' TEXT'</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">EXECUTE</span> <span class="string">'UPDATE '</span> || quote_ident(table_name) ||</span><br><span class="line">                <span class="string">' SET '</span> || quote_ident(column_name) ||</span><br><span class="line">                <span class="string">' = mz_normalize_id('</span> || quote_ident(prev_id_column_name) ||</span><br><span class="line">                <span class="string">', '</span> || quote_ident(geom_name) || <span class="string">')'</span> ||</span><br><span class="line">                <span class="string">' WHERE '</span> || quote_ident(prev_id_column_name) || <span class="string">' IS NOT NULL'</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql VOLATILE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_add_area_column()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_add_area_column(table_name <span class="built_in">text</span>, column_name <span class="built_in">text</span>, geom_name <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> VOID <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">IF</span> <span class="keyword">NOT</span> mz_does_column_exist(table_name, column_name) <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">EXECUTE</span> <span class="string">'ALTER TABLE '</span> || quote_ident(table_name) ||</span><br><span class="line">                <span class="string">' ADD COLUMN '</span> || quote_ident(column_name) ||</span><br><span class="line">                <span class="string">' REAL'</span>;</span></span><br><span class="line">        <span class="operator"><span class="keyword">EXECUTE</span> <span class="string">'UPDATE '</span> || quote_ident(table_name) || <span class="string">' SET '</span> || quote_ident(column_name) ||</span><br><span class="line">                <span class="string">' = ST_Area('</span> || quote_ident(geom_name) || <span class="string">') '</span> ||</span><br><span class="line">                <span class="string">'WHERE '</span> || quote_ident(geom_name) || <span class="string">' IS NOT NULL'</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql VOLATILE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_calculate_is_landuse()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-- functions to encapsulate logic for calculating new columns</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_calculate_is_landuse(</span><br><span class="line">    landuse_val <span class="built_in">text</span>, leisure_val <span class="built_in">text</span>, natural_val <span class="built_in">text</span>, highway_val <span class="built_in">text</span>, amenity_val <span class="built_in">text</span>, aeroway_val <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">BOOLEAN</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span></span><br><span class="line">        landuse_val <span class="keyword">IN</span> (<span class="string">'park'</span>, <span class="string">'forest'</span>, <span class="string">'residential'</span>, <span class="string">'retail'</span>, <span class="string">'commercial'</span>,</span><br><span class="line">                        <span class="string">'industrial'</span>, <span class="string">'railway'</span>, <span class="string">'cemetery'</span>, <span class="string">'grass'</span>, <span class="string">'farmyard'</span>,</span><br><span class="line">                        <span class="string">'farm'</span>, <span class="string">'farmland'</span>, <span class="string">'wood'</span>, <span class="string">'meadow'</span>, <span class="string">'village_green'</span>,</span><br><span class="line">                        <span class="string">'recreation_ground'</span>, <span class="string">'allotments'</span>, <span class="string">'quarry'</span>)</span><br><span class="line">     <span class="keyword">OR</span> leisure_val <span class="keyword">IN</span> (<span class="string">'park'</span>, <span class="string">'garden'</span>, <span class="string">'playground'</span>, <span class="string">'golf_course'</span>, <span class="string">'sports_centre'</span>,</span><br><span class="line">                        <span class="string">'pitch'</span>, <span class="string">'stadium'</span>, <span class="string">'common'</span>, <span class="string">'nature_reserve'</span>)</span><br><span class="line">     <span class="keyword">OR</span> natural_val <span class="keyword">IN</span> (<span class="string">'wood'</span>, <span class="string">'land'</span>, <span class="string">'scrub'</span>, <span class="string">'wetland'</span>, <span class="string">'glacier'</span>)</span><br><span class="line">     <span class="keyword">OR</span> highway_val <span class="keyword">IN</span> (<span class="string">'pedestrian'</span>, <span class="string">'footway'</span>)</span><br><span class="line">     <span class="keyword">OR</span> amenity_val <span class="keyword">IN</span> (<span class="string">'university'</span>, <span class="string">'school'</span>, <span class="string">'college'</span>, <span class="string">'library'</span>, <span class="string">'fuel'</span>,</span><br><span class="line">                        <span class="string">'parking'</span>, <span class="string">'cinema'</span>, <span class="string">'theatre'</span>, <span class="string">'place_of_worship'</span>, <span class="string">'hospital'</span>)</span><br><span class="line">     <span class="keyword">OR</span> aeroway_val <span class="keyword">IN</span> (<span class="string">'runway'</span>, <span class="string">'taxiway'</span>, <span class="string">'apron'</span>);</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql IMMUTABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_calculate_poi_level()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_calculate_poi_level(</span><br><span class="line">    aerialway_val <span class="built_in">text</span>,</span><br><span class="line">    aeroway_val <span class="built_in">text</span>,</span><br><span class="line">    amenity_val <span class="built_in">text</span>,</span><br><span class="line">    barrier_val <span class="built_in">text</span>,</span><br><span class="line">    highway_val <span class="built_in">text</span>,</span><br><span class="line">    historic_val <span class="built_in">text</span>,</span><br><span class="line">    leisure_val <span class="built_in">text</span>,</span><br><span class="line">    lock_val <span class="built_in">text</span>,</span><br><span class="line">    man_made_val <span class="built_in">text</span>,</span><br><span class="line">    natural_val <span class="built_in">text</span>,</span><br><span class="line">    power_val <span class="built_in">text</span>,</span><br><span class="line">    railway_val <span class="built_in">text</span>,</span><br><span class="line">    shop_val <span class="built_in">text</span>,</span><br><span class="line">    tourism_val <span class="built_in">text</span>,</span><br><span class="line">    waterway_val <span class="built_in">text</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">SMALLINT</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span> (</span><br><span class="line">        <span class="keyword">CASE</span> <span class="keyword">WHEN</span> aeroway_val <span class="keyword">IN</span> (<span class="string">'aerodrome'</span>, <span class="string">'airport'</span>) <span class="keyword">THEN</span> <span class="number">9</span></span><br><span class="line">             <span class="keyword">WHEN</span> natural_val <span class="keyword">IN</span> (<span class="string">'peak'</span>, <span class="string">'volcano'</span>) <span class="keyword">THEN</span> <span class="number">11</span></span><br><span class="line">             <span class="keyword">WHEN</span> railway_val <span class="keyword">IN</span> (<span class="string">'station'</span>) <span class="keyword">THEN</span> <span class="number">12</span></span><br><span class="line">             <span class="keyword">WHEN</span> (aerialway_val <span class="keyword">IN</span> (<span class="string">'station'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> railway_val <span class="keyword">IN</span> (<span class="string">'halt'</span>, <span class="string">'tram_stop'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> tourism_val <span class="keyword">IN</span> (<span class="string">'alpine_hut'</span>)) <span class="keyword">THEN</span> <span class="number">13</span></span><br><span class="line">             <span class="keyword">WHEN</span> (natural_val <span class="keyword">IN</span> (<span class="string">'spring'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> railway_val <span class="keyword">IN</span> (<span class="string">'level_crossing'</span>)) <span class="keyword">THEN</span> <span class="number">14</span></span><br><span class="line">             <span class="keyword">WHEN</span> (amenity_val <span class="keyword">IN</span> (<span class="string">'hospital'</span>, <span class="string">'parking'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> barrier_val <span class="keyword">IN</span> (<span class="string">'gate'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> highway_val <span class="keyword">IN</span> (<span class="string">'gate'</span>, <span class="string">'mini_roundabout'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> lock_val <span class="keyword">IN</span> (<span class="string">'yes'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> man_made_val <span class="keyword">IN</span> (<span class="string">'lighthouse'</span>, <span class="string">'power_wind'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> natural_val <span class="keyword">IN</span> (<span class="string">'cave_entrance'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> power_val <span class="keyword">IN</span> (<span class="string">'generator'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> waterway_val <span class="keyword">IN</span> (<span class="string">'lock'</span>)) <span class="keyword">THEN</span> <span class="number">15</span></span><br><span class="line">             <span class="keyword">WHEN</span> (aeroway_val <span class="keyword">IN</span> (<span class="string">'helipad'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> amenity_val <span class="keyword">IN</span> (<span class="string">'biergarten'</span>, <span class="string">'bus_station'</span>, <span class="string">'bus_stop'</span>, <span class="string">'car_sharing'</span>,</span><br><span class="line">                                    <span class="string">'picnic_site'</span>, <span class="string">'place_of_worship'</span>,</span><br><span class="line">                                    <span class="string">'prison'</span>, <span class="string">'pub'</span>, <span class="string">'recycling'</span>, <span class="string">'shelter'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> barrier_val <span class="keyword">IN</span> (<span class="string">'block'</span>, <span class="string">'bollard'</span>, <span class="string">'lift_gate'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> highway_val <span class="keyword">IN</span> (<span class="string">'bus_stop'</span>, <span class="string">'ford'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> historic_val <span class="keyword">IN</span> (<span class="string">'archaeological_site'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> man_made_val <span class="keyword">IN</span> (<span class="string">'windmill'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> natural_val <span class="keyword">IN</span> (<span class="string">'tree'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> shop_val <span class="keyword">IN</span> (<span class="string">'department_store'</span>, <span class="string">'supermarket'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> tourism_val <span class="keyword">IN</span> (<span class="string">'camp_site'</span>, <span class="string">'caravan_site'</span>, <span class="string">'information'</span>, <span class="string">'viewpoint'</span>)) <span class="keyword">THEN</span> <span class="number">16</span></span><br><span class="line">             <span class="keyword">WHEN</span> (aeroway_val <span class="keyword">IN</span> (<span class="string">'gate'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> amenity_val <span class="keyword">IN</span> (</span><br><span class="line">                 <span class="string">'atm'</span>, <span class="string">'bank'</span>, <span class="string">'bar'</span>, <span class="string">'bicycle_rental'</span>,</span><br><span class="line">                 <span class="string">'cafe'</span>, <span class="string">'cinema'</span>, <span class="string">'courthouse'</span>, <span class="string">'drinking_water'</span>, <span class="string">'embassy'</span>, <span class="string">'emergency_phone'</span>,</span><br><span class="line">                 <span class="string">'fast_food'</span>, <span class="string">'fire_station'</span>, <span class="string">'fuel'</span>, <span class="string">'library'</span>, <span class="string">'pharmacy'</span>,</span><br><span class="line">                 <span class="string">'police'</span>, <span class="string">'post_box'</span>, <span class="string">'post_office'</span>, <span class="string">'restaurant'</span>, <span class="string">'telephone'</span>, <span class="string">'theatre'</span>,</span><br><span class="line">                 <span class="string">'toilets'</span>, <span class="string">'veterinary'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> highway_val <span class="keyword">IN</span> (<span class="string">'traffic_signals'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> historic_val <span class="keyword">IN</span> (<span class="string">'memorial'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> leisure_val <span class="keyword">IN</span> (<span class="string">'playground'</span>, <span class="string">'slipway'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> man_made_val <span class="keyword">IN</span> (<span class="string">'mast'</span>, <span class="string">'water_tower'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> shop_val <span class="keyword">IN</span> (<span class="string">'bakery'</span>, <span class="string">'bicycle'</span>, <span class="string">'books'</span>, <span class="string">'butcher'</span>, <span class="string">'car'</span>, <span class="string">'car_repair'</span>,</span><br><span class="line">                                 <span class="string">'clothes'</span>, <span class="string">'computer'</span>, <span class="string">'convenience'</span>,</span><br><span class="line">                                 <span class="string">'doityourself'</span>, <span class="string">'dry_cleaning'</span>, <span class="string">'fashion'</span>, <span class="string">'florist'</span>, <span class="string">'gift'</span>,</span><br><span class="line">                                 <span class="string">'greengrocer'</span>, <span class="string">'hairdresser'</span>, <span class="string">'jewelry'</span>, <span class="string">'mobile_phone'</span>,</span><br><span class="line">                                 <span class="string">'optician'</span>, <span class="string">'pet'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> tourism_val <span class="keyword">IN</span> (<span class="string">'bed_and_breakfast'</span>, <span class="string">'chalet'</span>, <span class="string">'guest_house'</span>,</span><br><span class="line">                                    <span class="string">'hostel'</span>, <span class="string">'hotel'</span>, <span class="string">'motel'</span>, <span class="string">'museum'</span>)) <span class="keyword">THEN</span> <span class="number">17</span></span><br><span class="line">             <span class="keyword">WHEN</span> (amenity_val <span class="keyword">IN</span> (<span class="string">'bench'</span>, <span class="string">'waste_basket'</span>)</span><br><span class="line">                   <span class="keyword">OR</span> railway_val <span class="keyword">IN</span> (<span class="string">'subway_entrance'</span>)) <span class="keyword">THEN</span> <span class="number">18</span></span><br><span class="line">             <span class="keyword">ELSE</span> <span class="literal">NULL</span> <span class="keyword">END</span></span><br><span class="line">    );</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql IMMUTABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_calculate_road_level()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_calculate_road_level(highway_val <span class="built_in">text</span>, railway_val <span class="built_in">text</span>, aeroway_val <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">SMALLINT</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span> (</span><br><span class="line">        <span class="keyword">CASE</span> <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'motorway'</span>) <span class="keyword">THEN</span> <span class="number">7</span></span><br><span class="line">             <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'trunk'</span>, <span class="string">'primary'</span>, <span class="string">'secondary'</span>) <span class="keyword">THEN</span> <span class="number">10</span></span><br><span class="line">             <span class="keyword">WHEN</span> (highway_val <span class="keyword">IN</span> (<span class="string">'tertiary'</span>)</span><br><span class="line">                <span class="keyword">OR</span> aeroway_val <span class="keyword">IN</span> (<span class="string">'runway'</span>, <span class="string">'taxiway'</span>)) <span class="keyword">THEN</span> <span class="number">11</span></span><br><span class="line">             <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'motorway_link'</span>, <span class="string">'trunk_link'</span>, <span class="string">'residential'</span>, <span class="string">'unclassified'</span>, <span class="string">'road'</span>) <span class="keyword">THEN</span> <span class="number">12</span></span><br><span class="line">             <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'primary_link'</span>, <span class="string">'secondary_link'</span>) <span class="keyword">THEN</span> <span class="number">13</span></span><br><span class="line">             <span class="keyword">WHEN</span> (highway_val <span class="keyword">IN</span> (<span class="string">'tertiary_link'</span>, <span class="string">'minor'</span>)</span><br><span class="line">                <span class="keyword">OR</span> railway_val <span class="keyword">IN</span> (<span class="string">'rail'</span>, <span class="string">'subway'</span>)) <span class="keyword">THEN</span> <span class="number">14</span></span><br><span class="line">             <span class="keyword">WHEN</span> (highway_val <span class="keyword">IN</span> (<span class="string">'service'</span>, <span class="string">'footpath'</span>, <span class="string">'track'</span>, <span class="string">'footway'</span>, <span class="string">'steps'</span>, <span class="string">'pedestrian'</span>, <span class="string">'path'</span>, <span class="string">'cycleway'</span>, <span class="string">'living_street'</span>)</span><br><span class="line">                <span class="keyword">OR</span> railway_val <span class="keyword">IN</span> (<span class="string">'tram'</span>, <span class="string">'light_rail'</span>, <span class="string">'narrow_gauge'</span>, <span class="string">'monorail'</span>)) <span class="keyword">THEN</span> <span class="number">15</span></span><br><span class="line">             <span class="keyword">ELSE</span> <span class="literal">NULL</span> <span class="keyword">END</span></span><br><span class="line">    );</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql IMMUTABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_calculate_road_sort_key()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_calculate_road_sort_key(</span><br><span class="line">    layer_val <span class="built_in">text</span>, bridge_val <span class="built_in">text</span>, tunnel_val <span class="built_in">text</span>, highway_val <span class="built_in">text</span>, railway_val <span class="built_in">text</span>, aeroway_val <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">FLOAT</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">DECLARE</span> v_layer_as_float <span class="built_in">FLOAT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">    v_layer_as_float := mz_safe_convert_to_float(layer_val);</span></span><br><span class="line">    RETURN (</span><br><span class="line">        (CASE WHEN v_layer_as_float IS NOT NULL THEN 1000 * v_layer_as_float</span><br><span class="line">            ELSE 0</span><br><span class="line">            <span class="operator"><span class="keyword">END</span>)</span><br><span class="line"></span><br><span class="line">        +</span><br><span class="line"></span><br><span class="line">        <span class="comment">--</span></span><br><span class="line">        <span class="comment">-- Bridges and tunnels have an implicit physical layering.</span></span><br><span class="line">        <span class="comment">--</span></span><br><span class="line">        (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> bridge_val <span class="keyword">IN</span> (<span class="string">'yes'</span>, <span class="string">'true'</span>) <span class="keyword">THEN</span> <span class="number">100</span></span><br><span class="line">            <span class="keyword">WHEN</span> tunnel_val <span class="keyword">IN</span> (<span class="string">'yes'</span>, <span class="string">'true'</span>) <span class="keyword">THEN</span> -<span class="number">100</span></span><br><span class="line">            <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">END</span>)</span><br><span class="line"></span><br><span class="line">        +</span><br><span class="line"></span><br><span class="line">        <span class="comment">--</span></span><br><span class="line">        <span class="comment">-- Large roads are drawn on top of smaller roads.</span></span><br><span class="line">        <span class="comment">--</span></span><br><span class="line">        (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'motorway'</span>) <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">WHEN</span> railway_val <span class="keyword">IN</span> (<span class="string">'rail'</span>, <span class="string">'tram'</span>, <span class="string">'light_rail'</span>, <span class="string">'narrow_guage'</span>, <span class="string">'monorail'</span>) <span class="keyword">THEN</span> -.<span class="number">5</span></span><br><span class="line">            <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'trunk'</span>) <span class="keyword">THEN</span> -<span class="number">1</span></span><br><span class="line">            <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'primary'</span>) <span class="keyword">THEN</span> -<span class="number">2</span></span><br><span class="line">            <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'secondary'</span>) <span class="keyword">THEN</span> -<span class="number">3</span></span><br><span class="line">            <span class="keyword">WHEN</span> aeroway_val <span class="keyword">IN</span> (<span class="string">'runway'</span>) <span class="keyword">THEN</span> -<span class="number">3</span></span><br><span class="line">            <span class="keyword">WHEN</span> aeroway_val <span class="keyword">IN</span> (<span class="string">'taxiway'</span>) <span class="keyword">THEN</span> -<span class="number">3.5</span></span><br><span class="line">            <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'tertiary'</span>) <span class="keyword">THEN</span> -<span class="number">4</span></span><br><span class="line">            <span class="keyword">WHEN</span> highway_val <span class="keyword">LIKE</span> <span class="string">'%_link'</span> <span class="keyword">THEN</span> -<span class="number">5</span></span><br><span class="line">            <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'residential'</span>, <span class="string">'unclassified'</span>, <span class="string">'road'</span>) <span class="keyword">THEN</span> -<span class="number">6</span></span><br><span class="line">            <span class="keyword">WHEN</span> highway_val <span class="keyword">IN</span> (<span class="string">'unclassified'</span>, <span class="string">'service'</span>, <span class="string">'minor'</span>) <span class="keyword">THEN</span> -<span class="number">7</span></span><br><span class="line">            <span class="keyword">WHEN</span> railway_val <span class="keyword">IN</span> (<span class="string">'subway'</span>) <span class="keyword">THEN</span> -<span class="number">8</span></span><br><span class="line">            <span class="keyword">ELSE</span> -<span class="number">9</span> <span class="keyword">END</span>)</span><br><span class="line">    );</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql IMMUTABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_calculate_is_water()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_calculate_is_water(</span><br><span class="line">    waterway_val <span class="built_in">text</span>, natural_val <span class="built_in">text</span>, landuse_val <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">BOOLEAN</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span> (</span><br><span class="line">        waterway_val <span class="keyword">IN</span> (<span class="string">'riverbank'</span>, <span class="string">'dock'</span>)</span><br><span class="line">     <span class="keyword">OR</span> natural_val <span class="keyword">IN</span> (<span class="string">'water'</span>)</span><br><span class="line">     <span class="keyword">OR</span> landuse_val <span class="keyword">IN</span> (<span class="string">'basin'</span>, <span class="string">'reservoir'</span>)</span><br><span class="line">    );</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql IMMUTABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_calculate_is_building_or_part()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_calculate_is_building_or_part(</span><br><span class="line">    building_val <span class="built_in">text</span>, buildingpart_val <span class="built_in">text</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">BOOLEAN</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span> (building_val <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">OR</span> buildingpart_val <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>);</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql IMMUTABLE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- functions to temporarily enable and disable triggers</span></span><br><span class="line"><span class="comment">-- prevents them from firing while executing mass updates</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_tables_with_triggers()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_tables_with_triggers()</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">TEXT</span>[] <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="built_in">ARRAY</span>[<span class="string">'planet_osm_polygon'</span>, <span class="string">'planet_osm_line'</span>, <span class="string">'planet_osm_point'</span>, <span class="string">'water_polygons'</span>];</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql IMMUTABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_disable_triggers()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_disable_triggers()</span><br><span class="line"><span class="keyword">RETURNS</span> VOID <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">DECLARE</span> table_name <span class="built_in">TEXT</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">    FOREACH table_name <span class="keyword">IN</span> <span class="built_in">ARRAY</span> mz_tables_with_triggers()</span><br><span class="line">    LOOP</span><br><span class="line">        <span class="keyword">EXECUTE</span> <span class="string">'ALTER TABLE '</span> || quote_ident(table_name) ||</span><br><span class="line">                <span class="string">' DISABLE TRIGGER USER'</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span> LOOP;</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql VOLATILE;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_enable_triggers()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_enable_triggers()</span><br><span class="line"><span class="keyword">RETURNS</span> VOID <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">DECLARE</span> table_name <span class="built_in">TEXT</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">BEGIN</span></span><br><span class="line">    FOREACH table_name <span class="keyword">IN</span> <span class="built_in">ARRAY</span> mz_tables_with_triggers()</span><br><span class="line">    LOOP</span><br><span class="line">        <span class="keyword">EXECUTE</span> <span class="string">'ALTER TABLE '</span> || quote_ident(table_name) ||</span><br><span class="line">                <span class="string">' ENABLE TRIGGER USER'</span>;</span></span><br><span class="line">    <span class="operator"><span class="keyword">END</span> LOOP;</span></span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql VOLATILE;</span><br></pre></td></tr></table></figure>
<h3 id="导入的触发器">导入的触发器</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_trigger_function_landuse()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> mz_trigger_function_landuse()</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="keyword">TRIGGER</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">IF</span> mz_calculate_is_landuse(NEW.<span class="string">"landuse"</span>, NEW.<span class="string">"leisure"</span>, NEW.<span class="string">"natural"</span>, NEW.<span class="string">"highway"</span>, NEW.<span class="string">"amenity"</span>, NEW.<span class="string">"aeroway"</span>) <span class="keyword">then</span></span><br><span class="line">        NEW.mz_is_landuse := <span class="literal">TRUE</span>;</span></span><br><span class="line">        NEW.mz_centroid := ST_Centroid(NEW.way);</span><br><span class="line">    ELSE</span><br><span class="line">        NEW.mz_is_landuse := NULL;</span><br><span class="line">        NEW.mz_centroid := NULL;</span><br><span class="line">    <span class="operator"><span class="keyword">END</span> <span class="keyword">IF</span>;</span></span><br><span class="line">    RETURN NEW;</span><br><span class="line"><span class="operator"><span class="keyword">END</span>;</span></span><br><span class="line">$$ LANGUAGE plpgsql VOLATILE;</span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">DO</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">PERFORM mz_create_trigger_if_not_exists(<span class="string">'mz_trigger_landuse'</span>, <span class="string">'planet_osm_polygon'</span>, <span class="string">'mz_trigger_function_landuse'</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">END</span> $$;</span></span><br></pre></td></tr></table></figure>
<h3 id="拆分瓦片处理">拆分瓦片处理</h3><p>split_to_tiles.sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- This file contains functions (see `mz_SplitIntoTiles()`) for splitting a</span></span><br><span class="line"><span class="comment">-- table of polygons into uniform tiles. It was useful in integrating the</span></span><br><span class="line"><span class="comment">-- ne_10m_land Natural Earth dataset, which, downloaded straight from the</span></span><br><span class="line"><span class="comment">-- source, stores all seven continents in one monolithic multipolygon. That</span></span><br><span class="line"><span class="comment">-- makes `st_intersects()`/`st_intersection()` take absurdly long, since they</span></span><br><span class="line"><span class="comment">-- can't take advantage of any spatial indexes (which *would* help if it were</span></span><br><span class="line"><span class="comment">-- split up into many smaller polygons), and thus clogs up tile queries, which</span></span><br><span class="line"><span class="comment">-- depend on both of those functions. Hence, we split it into 10km x 10km tiles</span></span><br><span class="line"><span class="comment">-- using `mz_SplitIntoTiles()`.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_CreateGrid()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-- A function that creates a table containing a grid of cells, taken from here:</span></span><br><span class="line"><span class="comment">-- http://gis.stackexchange.com/questions/16374/how-to-create-a-regular-polygon-grid-in-postgis</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> mz_CreateGrid(</span><br><span class="line">	numberX <span class="built_in">integer</span>,</span><br><span class="line">	numberY <span class="built_in">integer</span>,</span><br><span class="line">	xsize float8,</span><br><span class="line">	ysize float8,</span><br><span class="line">	x0 float8 <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">	y0 float8 <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">	out <span class="string">"row"</span> <span class="built_in">integer</span>,</span><br><span class="line">	out col <span class="built_in">integer</span>,</span><br><span class="line">	out the_geom geometry</span><br><span class="line">)</span><br><span class="line"><span class="keyword">returns</span> setof record <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line">	<span class="keyword">select</span></span><br><span class="line">		rowInd + <span class="number">1</span> <span class="keyword">as</span> <span class="keyword">row</span>,</span><br><span class="line">		colInd + <span class="number">1</span> <span class="keyword">as</span> col,</span><br><span class="line">		st_Translate(cell, colInd * xsize + x0, rowInd * ysize + y0) <span class="keyword">as</span> the_geom</span><br><span class="line">	<span class="keyword">from</span></span><br><span class="line">		generate_series(<span class="number">0</span>, numberY - <span class="number">1</span>) <span class="keyword">as</span> rowInd,</span><br><span class="line">		generate_series(<span class="number">0</span>, numberX - <span class="number">1</span>) <span class="keyword">as</span> colInd,</span><br><span class="line">		(<span class="keyword">select</span> (<span class="keyword">format</span>(<span class="string">'POLYGON((0 0, 0 %s, %s %s, %s 0,0 0))'</span>, ysize, xsize, ysize, xsize))::geometry <span class="keyword">as</span> cell) <span class="keyword">as</span> foo;</span></span><br><span class="line">$$ language sql immutable strict;</span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">--               mz_SplitIntoTiles()</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-- Split the polygons in a table called `table_name` into uniformly sized tiles</span></span><br><span class="line"><span class="comment">-- in a table called `$&#123;table_name&#125;_tiles`.</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> mz_SplitIntoTiles(</span><br><span class="line">	table_name <span class="built_in">text</span>,</span><br><span class="line">	tile_size_meters <span class="built_in">integer</span>,</span><br><span class="line">	geom_column_name <span class="built_in">text</span> <span class="keyword">default</span> <span class="string">'the_geom'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">returns</span> void <span class="keyword">as</span></span><br><span class="line">$$</span><br><span class="line">	<span class="keyword">declare</span></span><br><span class="line">		grid_table_name <span class="built_in">text</span> := table_name || <span class="string">'_grid'</span>;</span></span><br><span class="line">		table_bbox box2d;</span><br><span class="line">		num_tiles_x integer;</span><br><span class="line">		num_tiles_y integer;</span><br><span class="line">	<span class="operator"><span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">execute</span> <span class="keyword">format</span>(<span class="string">'select st_extent(%s) from %s'</span>, geom_column_name, table_name) <span class="keyword">into</span> table_bbox;</span></span><br><span class="line">		num_tiles_x = ceiling(</span><br><span class="line">			(st_xmax(table_bbox) - st_xmin(table_bbox)) / (tile_size_meters :: float)</span><br><span class="line">		);</span><br><span class="line">		num_tiles_y = ceiling(</span><br><span class="line">			(st_ymax(table_bbox) - st_ymin(table_bbox)) / (tile_size_meters :: float)</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		<span class="comment">-- Create a table containing a grid with cells of length/width</span></span><br><span class="line">		<span class="comment">-- `tile_size_meters`, covering the entire extent of `table_name`.</span></span><br><span class="line">		<span class="operator"><span class="keyword">execute</span> <span class="keyword">format</span>(</span><br><span class="line">			<span class="string">'create table %s as</span><br><span class="line">			select *</span><br><span class="line">			from MZ_CreateGrid(%s, %s, %s, %s, %s, %s);'</span>,</span><br><span class="line">			grid_table_name, num_tiles_x, num_tiles_y,</span><br><span class="line">			tile_size_meters, tile_size_meters,</span><br><span class="line">			st_xmin(table_bbox), st_ymin(table_bbox)</span><br><span class="line">		);</span></span><br><span class="line">		perform UpdateGeometrySRID(grid_table_name, 'the_geom', 900913);</span><br><span class="line">		<span class="operator"><span class="keyword">execute</span> <span class="keyword">format</span>(<span class="string">'create index %s_index on %1$s using gist(the_geom)'</span>, grid_table_name);</span></span><br><span class="line"></span><br><span class="line">		<span class="operator"><span class="keyword">execute</span> <span class="keyword">format</span>(<span class="string">'create sequence %1$s_ids;'</span>, table_name);</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">-- Intersect the gridded cells with the polygons in `table_name`,</span></span><br><span class="line">		<span class="comment">-- storing the now-tiled polygons in `$&#123;table_name&#125;_tiles`. Assign each</span></span><br><span class="line">		<span class="comment">-- a unique `gid`.</span></span><br><span class="line">		<span class="operator"><span class="keyword">execute</span> <span class="keyword">format</span>(</span><br><span class="line">			<span class="string">'create table %1$s_tiles as</span><br><span class="line">			select</span><br><span class="line">				nextval(''%1$s_ids'')::int as gid,</span><br><span class="line">				st_intersection(%1$s.%3$s, %2$s.the_geom) as the_geom</span><br><span class="line">			from %1$s</span><br><span class="line">			join %2$s</span><br><span class="line">			on (</span><br><span class="line">				st_isvalid(%1$s.%3$s) and</span><br><span class="line">				st_intersects(%1$s.%3$s, %2$s.the_geom)</span><br><span class="line">			);'</span>,</span><br><span class="line">			table_name, grid_table_name, geom_column_name</span><br><span class="line">		);</span></span><br><span class="line"></span><br><span class="line">		<span class="operator"><span class="keyword">execute</span> <span class="string">'drop table '</span> || grid_table_name;</span></span><br><span class="line">	<span class="operator"><span class="keyword">end</span></span><br><span class="line">$$ <span class="keyword">language</span> plpgsql;</span></span><br></pre></td></tr></table></figure>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/02/27/GIS/用python写一个osm2rdbms导入工具/">
                用python写一个osm2rdbms导入工具
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2015-02-27
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/02/27/GIS/用python写一个osm2rdbms导入工具/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/27/GIS/用python写一个osm2rdbms导入工具/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h3 id="代码">代码</h3><p>首先贴出代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> osgeo <span class="keyword">import</span> ogr</span><br><span class="line"><span class="keyword">import</span> pyodbc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    src_conn_info = <span class="string">"../shape_eg_data/pline.shp"</span></span><br><span class="line">    dst_conn_info = <span class="string">"DSN=svde;SERVER=127.0.0.1;TCP_PORT=5236;UID=SYSDBA;PWD=SYSDBA;"</span></span><br><span class="line"></span><br><span class="line">    ogr_dm_type_mapping = &#123;</span><br><span class="line">            <span class="string">'0'</span> : <span class="string">'integer'</span>,</span><br><span class="line">            <span class="string">'1'</span> : <span class="string">'double'</span>,</span><br><span class="line">            <span class="string">'2'</span> : <span class="string">'varchar'</span>,</span><br><span class="line">            <span class="string">'3'</span> : <span class="string">'varchar'</span>,</span><br><span class="line">            <span class="string">'4'</span> : <span class="string">'varchar'</span>,</span><br><span class="line">            <span class="string">'5'</span> : <span class="string">'varchar'</span>,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    ogr_geom_type_mapping = &#123;</span><br><span class="line">            <span class="string">'0'</span> : <span class="string">'Point'</span>,</span><br><span class="line">            <span class="string">'1'</span> : <span class="string">'LineString'</span>,</span><br><span class="line">            <span class="string">'2'</span> : <span class="string">'Polygon'</span>,</span><br><span class="line">            <span class="string">'3'</span> : <span class="string">'MultiPoint'</span>,</span><br><span class="line">            <span class="string">'4'</span> : <span class="string">'MultiLineString'</span>,</span><br><span class="line">            <span class="string">'5'</span> : <span class="string">'MultiPolygon'</span>,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    dm_conn = pyodbc.connect(dst_conn_info)</span><br><span class="line">    cursor = dm_conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ensure metadata talbes exsits</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cursor.execute(<span class="string">"""select 1 from svde_metadata"""</span>)</span><br><span class="line">    <span class="keyword">except</span> pyodbc.ProgrammingError:</span><br><span class="line">        cursor.execute(<span class="string">"""create table svde_metadata(</span><br><span class="line">                        table_name varchar primary key,</span><br><span class="line">                        geom_column_name varchar not null,</span><br><span class="line">                        geom_type varchar,</span><br><span class="line">                        geom_dimension varchar,</span><br><span class="line">                        geom_srid varchar)"""</span>)</span><br><span class="line">        cursor.execute(<span class="string">"""create table svde_srs(</span><br><span class="line">                        srid varchar primary key,</span><br><span class="line">                        auth_name varchar,</span><br><span class="line">                        auth_srid varchar,</span><br><span class="line">                        srtext varchar not null,</span><br><span class="line">                        proj4text varchar)"""</span>)</span><br><span class="line">        cursor.execute(<span class="string">"""create table svde_column_defn(</span><br><span class="line">                        cid varchar,</span><br><span class="line">                        table_name varchar not null,</span><br><span class="line">                        column_name varchar not null,</span><br><span class="line">                        column_type varchar not null,</span><br><span class="line">                        primary key (table_name, column_name))"""</span>)</span><br><span class="line">        cursor.commit()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"metadata tables already exists in database!"</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create table for shapefile layer</span></span><br><span class="line"></span><br><span class="line">    ds = ogr.Open(src_conn_info)</span><br><span class="line">    layer = ds.GetLayer()</span><br><span class="line">    layer_defn = layer.GetLayerDefn()</span><br><span class="line">    field_count = layer_defn.GetFieldCount()</span><br><span class="line"></span><br><span class="line">    fields_type_dict = &#123;&#125;</span><br><span class="line">    fields_defn_serial = <span class="string">""</span></span><br><span class="line">    fields_comma_serial = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, field_count-<span class="number">1</span>):</span><br><span class="line">        field_name = layer_defn.GetFieldDefn(i).GetName()</span><br><span class="line">        field_type = layer_defn.GetFieldDefn(i).GetType()</span><br><span class="line">        fields_type_dict[field_name] = ogr_dm_type_mapping[str(field_type)]</span><br><span class="line">        fields_defn_serial += field_name + <span class="string">' '</span> + ogr_dm_type_mapping[str(field_type)] + <span class="string">','</span></span><br><span class="line">        fields_comma_serial += field_name + <span class="string">','</span></span><br><span class="line"></span><br><span class="line">    fields_defn_serial = fields_defn_serial.rstrip(<span class="string">', '</span>)</span><br><span class="line">    fields_comma_serial = fields_comma_serial.rstrip(<span class="string">', '</span>)</span><br><span class="line"></span><br><span class="line">    table_name = layer_defn.GetName()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"fields_comma_serial"</span> + fields_comma_serial</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"""create table %s (</span><br><span class="line">                   %s,</span><br><span class="line">                   fid varchar primary key,</span><br><span class="line">                   geom varchar)"""</span> % (table_name, fields_defn_serial)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cursor.execute(<span class="string">"""select 1 from %s"""</span> % (table_name) )</span><br><span class="line">    <span class="keyword">except</span> pyodbc.ProgrammingError:</span><br><span class="line">        <span class="comment"># 1] create table for layer</span></span><br><span class="line">        <span class="comment"># 2] register geom colum in svde_metadata </span></span><br><span class="line">        <span class="comment"># 3] register column in svde_column_defn</span></span><br><span class="line">        cursor.execute(<span class="string">"""create table %s (</span><br><span class="line">                       %s,</span><br><span class="line">                       fid varchar primary key,</span><br><span class="line">                       geom varchar)"""</span> % (table_name, fields_defn_serial) ) </span><br><span class="line">        cursor.commit()</span><br><span class="line"></span><br><span class="line">        geom_type = ogr_geom_type_mapping[str(layer_defn.GetGeomType())]</span><br><span class="line">        geom_dimension = str(<span class="number">2</span>)</span><br><span class="line">        geom_srid = str(<span class="number">900913</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">print</span> <span class="string">"""insert into svde_metadata(table_name, geom_column_name, geom_type,</span><br><span class="line">                geom_dimension, geom_srid) values (%s, 'geom', %s, %s, %s)</span><br><span class="line">                """</span> % (repr(table_name), repr(geom_type), repr(geom_dimension), repr(geom_srid) )</span><br><span class="line"></span><br><span class="line">        cursor.execute(<span class="string">"""insert into svde_metadata(table_name, geom_column_name, geom_type,</span><br><span class="line">                geom_dimension, geom_srid) values (%s, 'geom', %s, %s, %s)</span><br><span class="line">                """</span> % (repr(table_name), repr(geom_type), repr(geom_dimension), repr(geom_srid) ) )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> fields_type_dict</span><br><span class="line">        <span class="keyword">for</span> cname, cvalue <span class="keyword">in</span> fields_type_dict.items():</span><br><span class="line">            cursor.execute(<span class="string">"""insert into svde_column_defn( table_name, column_name, column_type)</span><br><span class="line">                            values ('%s', '%s', '%s')"""</span> % (table_name, cname, str(cvalue)) )</span><br><span class="line">        cursor.commit()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"table "</span> + str(table_name) + <span class="string">"already exsit"</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read shapefile layer into OGR objects and Persist ogr objects into dameng </span></span><br><span class="line">    </span><br><span class="line">    fid = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> feat <span class="keyword">in</span> layer:</span><br><span class="line">        fid = fid + <span class="number">1</span></span><br><span class="line">        values_comma_serial = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, field_count-<span class="number">1</span>):</span><br><span class="line">            value = feat.GetFieldAsString(i)</span><br><span class="line">            values_comma_serial += repr(value) + <span class="string">','</span></span><br><span class="line"></span><br><span class="line">        values_comma_serial = values_comma_serial.rstrip(<span class="string">','</span>)</span><br><span class="line">        geom_wkt = feat.GetGeometryRef().ExportToWkt()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"""insert into %s(%s, fid, geom) values (%s, '%s' , '%s')"""</span> % (</span><br><span class="line">            table_name, fields_comma_serial, values_comma_serial, str(fid), geom_wkt) </span><br><span class="line">        </span><br><span class="line">        cursor.execute(<span class="string">"""insert into %s(%s, fid, geom) values (%s, '%s' , '%s')"""</span> % (</span><br><span class="line">            table_name, fields_comma_serial, values_comma_serial, str(fid), geom_wkt) )</span><br><span class="line">        <span class="comment"># allowed most 100 sql statement, so should not commit after execute all</span></span><br><span class="line">        cursor.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__  ==   <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2014/12/09/Programming/C-API设计总结/">
                C++_API设计总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2014-12-09
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/12/09/Programming/C-API设计总结/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/12/09/Programming/C-API设计总结/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2014/12/08/GIS/GIS空间索引技术总结/">
                GIS空间索引技术总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2014-12-08
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/12/08/GIS/GIS空间索引技术总结/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/12/08/GIS/GIS空间索引技术总结/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h3 id="GIS索引技术总结">GIS索引技术总结</h3><ul>
<li>网格索引</li>
<li>四叉树索引</li>
<li>R树系列索引</li>
</ul>
<h3 id="网格索引">网格索引</h3><h3 id="四叉树索引">四叉树索引</h3><h3 id="R树系列索引">R树系列索引</h3>
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2014/11/10/Programming/设计模式总结/">
                设计模式总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2014-11-10
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/11/10/Programming/设计模式总结/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/11/10/Programming/设计模式总结/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2014/10/29/Linux/服务器IO模型总结/">
                服务器IO模型总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2014-10-29
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/10/29/Linux/服务器IO模型总结/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/10/29/Linux/服务器IO模型总结/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2014/10/08/Linux/服务器并发策略总结/">
                服务器并发策略总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2014-10-08
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/10/08/Linux/服务器并发策略总结/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/10/08/Linux/服务器并发策略总结/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2014/05/04/DataBase/PostGIS总结/">
                PostGIS总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2014-05-04
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/05/04/DataBase/PostGIS总结/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/05/04/DataBase/PostGIS总结/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2014/04/14/DataBase/为什么NoSQL/">
                为什么NoSQL
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2014-04-14
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2014/04/14/DataBase/为什么NoSQL/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2014/04/14/DataBase/为什么NoSQL/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h3 id=""> </h3><p>在Youtube上看了fall Martin的关于NoSQL的演讲视频<a href="">Introduction of NoSQL</a>收获很多，然而之前并木有想到坐着想打的这些问题，如是做一下总结：</p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
  </div>

  
  <div class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">&raquo;</a>
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="https://avatars3.githubusercontent.com/u/4932234" alt="Fei Lunzhou" />
          <p class="site-author-name">Fei Lunzhou</p>
        </div>
        <p class="site-description motion-element"></p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">23</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分類</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">5</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/universefei" target="_blank">github</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/" target="_blank">weibo</a>
            </span>
            
          
        </div>

        
        

      </div>

      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Fei Lunzhou</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.3"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.3"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.3" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  

  
  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"feilunzhou"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  


  
  

</body>
</html>
